- filename: db/__init__.py
  content: |
    from .db_manager import Base, SQLiteManager

- filename: db/db_manager.py
  content: |
    import os
    from sqlalchemy import create_engine, inspect
    from sqlalchemy.engine import Engine
    from sqlalchemy.orm import declarative_base, sessionmaker, Session
    from typing import Generator, Type
    from functools import cached_property

    Base = declarative_base()

    class SQLiteManager:
        def __init__(self, db_name: str, base_dir: str = './db', echo: bool = False):
            self.db_name = db_name
            self.base_dir = base_dir
            self.echo = echo

        @cached_property
        def db_path(self) -> str:
            return os.path.join(self.base_dir, f"{{self.db_name}}.db")

        @cached_property
        def db_url(self) -> str:
            return f"sqlite:///{{self.db_path}}"

        @cached_property
        def db_engine(self) -> Engine:
            return create_engine(self.db_url, echo=self.echo)

        def create_session(self) -> Session:
            return sessionmaker(bind=self.db_engine)()

        def get_db(self) -> Generator[Session, None, None]:
            '''Create a session and yield it to the caller function'''
            db = self.create_session()
            try:
                yield db
            finally:
                db.close()

        def create_tables(self):
            Base.metadata.create_all(bind=self.db_engine)

        def create_table(self, table_model: Type[Base]):
            inspector = inspect(self.db_engine)
            table_name = table_model.__tablename__
            if table_name not in inspector.get_table_names():
                table_model.__table__.create(self.db_engine)
                if self.echo:
                    print(f"Table {{table_name}} created successfully")
            elif self.echo:
                print(f"Table {{table_name}} already exists")

        def __repr__(self) -> str:
            return self.db_url